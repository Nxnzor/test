<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:'Segoe UI',Tahoma}
body{margin:0;background:#f4f6f8;padding:30px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
.card{background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 20px rgba(0,0,0,.08)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#f1f1f1}
.risk-low{color:green}
.risk-mid{color:orange}
.risk-high{color:red}
.chart-btn{padding:8px 14px;border-radius:8px;border:none;background:#6a5acd;color:#fff;cursor:pointer;margin-right:6px}
.logout{margin-top:30px;padding:10px 20px;border:none;border-radius:999px;background:#e53935;color:#fff;cursor:pointer}
</style>
</head>

<body>

<h1>Admin Dashboard</h1>

<div class="grid">
  <div class="card"><h3>üëÅÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</h3><p id="visitorCount">0</p></div>
  <div class="card"><h3>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p id="userCount">0</p></div>
  <div class="card"><h3>üòä ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ</h3><p id="goodCount">0</p></div>
  <div class="card"><h3>üòê ‡πÄ‡∏â‡∏¢ ‡πÜ</h3><p id="midCount">0</p></div>
  <div class="card"><h3>üò¢ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏¢‡πà</h3><p id="badCount">0</p></div>
</div>

<div class="card">
<h3>üë§ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
<table>
<thead>
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠</th>
<th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
<th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<br>

<div class="card">
<h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</h3>
<button class="chart-btn" onclick="renderChart()">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<canvas id="moodChart" height="120"></canvas>
</div>

<button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby2w_EEmgs-vbNzvNo6uc2Ntkd8I-7LTmb_EmTy4Yho7lmWyDwn9fp8cAD31YiUQvSD/exec";

/* ===== Auth ===== */
if(localStorage.getItem("adminLogin")!=="true"){
  location.href="admin-login.html";
}

function logout(){
  localStorage.removeItem("adminLogin");
  location.href="index.html";
}

let chart;
let allDiary=[];

/* ===== Load Data ===== */
fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  document.getElementById("visitorCount").innerText=data.totalVisits+" ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  document.getElementById("userCount").innerText=data.users.length+" ‡∏Ñ‡∏ô";

  renderUsers(data.users);
  fetchDiaryForChart();
});

/* ===== Users Table ===== */
function renderUsers(users){
  const tb=document.getElementById("userTable");
  tb.innerHTML="";
  users.forEach(u=>{
    const risk=getRisk(u);
    tb.innerHTML+=`
      <tr>
        <td>${u.username}</td>
        <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():"-"}</td>
        <td>${u.diaryCount}</td>
        <td class="${risk.class}">${risk.text}</td>
      </tr>`;
  });
}

function getRisk(u){
  if(u.diaryCount===0) return {text:"‡∏ï‡πà‡∏≥",class:"risk-low"};
  if(u.diaryCount>=5) return {text:"‡∏™‡∏π‡∏á",class:"risk-high"};
  return {text:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",class:"risk-mid"};
}

/* ===== Chart ===== */
function fetchDiaryForChart(){
  fetch(API_URL+"?mode=diary")
  .then(r=>r.json())
  .then(d=>{
    allDiary=d;
    renderChart();
  });
}

function renderChart(){
  let good=0,mid=0,bad=0;
  allDiary.forEach(d=>{
    if(d.mood==="üòä") good++;
    else if(d.mood==="üòê") mid++;
    else bad++;
  });

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("moodChart"),{
    type:"bar",
    data:{
      labels:["‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ","‡πÄ‡∏â‡∏¢ ‡πÜ","‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏¢‡πà"],
      datasets:[{data:[good,mid,bad],backgroundColor:["#66bb6a","#ffa726","#ef5350"]}]
    },
    options:{plugins:{legend:{display:false}}}
  });

  document.getElementById("goodCount").innerText=good;
  document.getElementById("midCount").innerText=mid;
  document.getElementById("badCount").innerText=bad;
}
</script>

</body>
</html>
