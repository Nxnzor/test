<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            margin: 0;
            background: #f4f6f8;
            padding: 30px;
        }

        h1 {
            margin-bottom: 20px;
        }

        /* ===== Summary Cards ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }

        /* ===== Table ===== */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background: #f1f1f1;
        }

        .risk-low { color: green; }
        .risk-mid { color: orange; }
        .risk-high { color: red; }

        /* ===== Chart Buttons ===== */
        .chart-controls {
            margin-bottom: 12px;
        }

        .chart-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: #6a5acd;
            color: white;
            margin-right: 6px;
        }

        .chart-btn:hover {
            opacity: 0.9;
        }

        /* ===== Logout ===== */
        .logout {
            margin-top: 30px;
            padding: 10px 20px;
            border: none;
            border-radius: 999px;
            background: #e53935;
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body>

<h1>Admin Dashboard</h1>

<!-- ===== Summary ===== -->
<div class="grid">
    <div class="card">
        <h3>üëÅÔ∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</h3>
        <p id="visitorCount">0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
    </div>
    <div class="card">
        <h3>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p id="userCount">0 ‡∏Ñ‡∏ô</p>
    </div>
    <div class="card">
        <h3>üòä ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ</h3>
        <p id="goodCount">0</p>
    </div>
    <div class="card">
        <h3>üòê ‡πÄ‡∏â‡∏¢ ‡πÜ</h3>
        <p id="midCount">0</p>
    </div>
    <div class="card">
        <h3>üò¢ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏¢‡πà</h3>
        <p id="badCount">0</p>
    </div>
</div>

<!-- ===== Users Table ===== -->
<div class="card">
    <h3>üë§ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
    <table>
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
</div>

<br>

<!-- ===== Chart ===== -->
<div class="card">
    <h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</h3>

    <div class="chart-controls">
        <button class="chart-btn" onclick="showAllTime()">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="chart-btn" onclick="showWeekly()">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
    </div>

    <canvas id="moodChart" height="120"></canvas>
</div>

<button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

<script>
/* ===== Auth ===== */
if (localStorage.getItem("adminLogin") !== "true") {
    window.location.href = "admin-login.html";
}

/* ===== Logout ===== */
function logout() {
    localStorage.removeItem("adminLogin");
    window.location.href = "index.html";
}

/* ===== Data ===== */
const users = JSON.parse(localStorage.getItem("users")) || {};
const userTable = document.getElementById("userTable");

/* ===== Visitor ===== */
document.getElementById("visitorCount").innerText =
    (localStorage.getItem("visitCount") || 0) + " ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";

document.getElementById("userCount").innerText =
    Object.keys(users).length + " ‡∏Ñ‡∏ô";

/* ===== Diaries ===== */
function getAllDiaries() {
    let diaries = [];
    Object.keys(users).forEach(user => {
        const d = JSON.parse(localStorage.getItem(`diaries_${user}`)) || [];
        diaries = diaries.concat(d.map(x => ({ ...x, user })));
    });
    return diaries;
}

function countMood(diaries) {
    let good = 0, mid = 0, bad = 0;
    diaries.forEach(d => {
        if (d.mood === "üòä") good++;
        else if (d.mood === "üòê") mid++;
        else bad++;
    });
    return [good, mid, bad];
}

function getRisk(diaries) {
    if (diaries.length === 0) return { text: "‡∏ï‡πà‡∏≥", class: "risk-low" };
    const mood = diaries[0].mood;
    if (mood === "üò¢" || mood === "üò°") return { text: "‡∏™‡∏π‡∏á", class: "risk-high" };
    if (mood === "üòê") return { text: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", class: "risk-mid" };
    return { text: "‡∏ï‡πà‡∏≥", class: "risk-low" };
}

/* ===== Fill Table ===== */
Object.keys(users).forEach(username => {
    const diaries = JSON.parse(localStorage.getItem(`diaries_${username}`)) || [];
    const risk = getRisk(diaries);

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${username}</td>
        <td>${users[username].lastLogin || "-"}</td>
        <td class="${risk.class}">${risk.text}</td>
    `;
    userTable.appendChild(tr);
});

/* ===== Chart ===== */
let chart;

function renderChart(data) {
    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("moodChart"), {
        type: "bar",
        data: {
            labels: ["‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ", "‡πÄ‡∏â‡∏¢ ‡πÜ", "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏¢‡πà"],
            datasets: [{
                data: data,
                backgroundColor: ["#66bb6a", "#ffa726", "#ef5350"]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });

    document.getElementById("goodCount").innerText = data[0];
    document.getElementById("midCount").innerText = data[1];
    document.getElementById("badCount").innerText = data[2];
}

/* ===== Modes ===== */
function showAllTime() {
    const diaries = getAllDiaries();
    renderChart(countMood(diaries));
}

function showWeekly() {
    const now = new Date();
    const diaries = getAllDiaries().filter(d => {
        const diff = (now - new Date(d.date)) / (1000 * 60 * 60 * 24);
        return diff <= 7;
    });
    renderChart(countMood(diaries));
}

/* ===== Init ===== */
showAllTime();
</script>

</body>
</html>
