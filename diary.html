<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>My Private Diary</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(#e3f2fd, #fce4ec);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }

        .card {
            background: #fff;
            width: 420px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            resize: none;
            margin-bottom: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: #ffa366;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .logout {
            background: #ffd6c9;
            color: #333;
        }

        .diary-item {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
            font-size: 14px;
        }

        canvas {
            margin-top: 15px;
        }
    </style>
</head>

<body>

<div class="card">
    <h2>üß° ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
    <p id="welcome"></p>

    <div>
        <strong>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á?</strong><br>
        <input type="radio" name="mood" value="üòä"> üòä
        <input type="radio" name="mood" value="üòê"> üòê
        <input type="radio" name="mood" value="üò¢"> üò¢
        <input type="radio" name="mood" value="üò°"> üò°
    </div>

    <br>

    <textarea id="diaryText" placeholder="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á..."></textarea>

    <button onclick="saveDiary()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

    <h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
    <canvas id="stressChart"></canvas>

    <h3>üìö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
    <div id="history"></div>

    <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<script>
    /* ===== Google Apps Script API ===== */
    const API_URL =
        "https://script.google.com/macros/s/AKfycbyWHef8FUkvYV2Klc75K3OrOoSO091GwfxogEp4IK8ccjr7tRpNp-SsRzzL6pzhs3MT/exec";

    const user = localStorage.getItem("currentUser");
    if (!user) window.location.href = "login.html";

    document.getElementById("welcome").innerText =
        `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${user} üíô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á`;

    let chart;

    function saveDiary() {
        const text = document.getElementById("diaryText").value.trim();
        const moodEl = document.querySelector('input[name="mood"]:checked');

        if (!text || !moodEl) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            return;
        }

        const mood = moodEl.value;

        /* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Google Sheet */
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveDiary",
                username: user,
                mood,
                text
            })
        }).catch(console.error);

        /* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å localStorage */
        const key = `diaries_${user}`;
        const diaries = JSON.parse(localStorage.getItem(key)) || [];

        diaries.unshift({
            time: new Date().toLocaleString(),
            mood,
            text
        });

        localStorage.setItem(key, JSON.stringify(diaries));

        document.getElementById("diaryText").value = "";
        moodEl.checked = false;

        loadDiary();
        updateChart();
    }

    function loadDiary() {
        const key = `diaries_${user}`;
        const diaries = JSON.parse(localStorage.getItem(key)) || [];
        const history = document.getElementById("history");

        history.innerHTML = "";

        diaries.forEach(d => {
            const div = document.createElement("div");
            div.className = "diary-item";
            div.innerHTML = `
                <strong>${d.time}</strong> ${d.mood}<br>
                ${d.text}
            `;
            history.appendChild(div);
        });
    }

    /* ===== ‡∏Å‡∏£‡∏≤‡∏ü (‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô / ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß) ===== */
    function updateChart() {
        const key = `diaries_${user}`;
        const diaries = JSON.parse(localStorage.getItem(key)) || [];
        const today = new Date().toLocaleDateString();

        const moodMap = {
            "üòä": 1,
            "üòê": 2,
            "üò¢": 4,
            "üò°": 5
        };

        const labels = [];
        const data = [];

        diaries.slice().reverse().forEach(d => {
            if (d.time.includes(today)) {
                labels.push(d.time.split(" ")[1] || "");
                data.push(moodMap[d.mood]);
            }
        });

        if (chart) chart.destroy();

        chart = new Chart(document.getElementById("stressChart"), {
            type: "line",
            data: {
                labels,
                datasets: [{
                    label: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (1=‡∏î‡∏µ 5=‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å)",
                    data,
                    borderColor: "#ff8a65",
                    backgroundColor: "rgba(255,138,101,0.2)",
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                scales: {
                    y: {
                        min: 0,
                        max: 5,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

    function logout() {
        localStorage.removeItem("currentUser");
        window.location.href = "login.html";
    }

    loadDiary();
    updateChart();
</script>

</body>
</html>

